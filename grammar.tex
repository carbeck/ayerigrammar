% arara: xelatex
% arara: biber
% arara: makeglossaries
% arara: makeindex
% arara: xelatex

\documentclass[
	a4paper,
	12pt,
	openany,
	twoside,
	oldfontcommands, % Compatibility with expex, which still uses \rm
]{memoir}

% % Setup for 'U.S. trade paperback' (6x9 in). Tables are all formatted wrong and 
% % some examples are also problematic. Use option 'showtrims' in document class 
% % declaration above to show trim marks for where to cut the stock paper.
% \setstocksize{9in}{6in}
% \settrimmedsize{9in}{6in}{*}
% \setulmarginsandblock{1in}{*}{*}
% \setlrmarginsandblock{*}{0.75in}{1.0}
% \checkandfixthelayout

\author{Carsten Becker}
\title{A Grammar of Ayeri: Documenting a Fictional Language}
\date{\today}

% Layout for title page, cf. titlepages package
\newlength\drop
\makeatletter
\newcommand*{\titleS}{\begingroup% Scripts, T&H p 151
\drop = 0.1\textheight
\centering
\vspace*{\drop}
{\Huge A Grammar of Ayeri}\\[\baselineskip]
{\Large\scshape Documenting a Fictional Language}\\[\baselineskip]
{\large\itshape by Carsten Becker}\\[\baselineskip]
\vfill
\rule{0.4\textwidth}{0.4pt}\\[\baselineskip]
{\large\itshape Benung.~The Ayeri Language Resource}\par
\vspace*{\drop}
\endgroup}
\makeatother

% Layout for running page titles
\nouppercaseheads
% \copypagestyle{sfheaders}{headings}
% \makeevenhead{sfheaders}{\sffamily\bfseries\thepage}{}{\sffamily\itshape\leftmark}
% \makeoddhead{sfheaders}{\sffamily\itshape\rightmark}{}{\sffamily\bfseries\thepage}
% \makeheadrule{headings}{\textwidth}{0.3pt}
% \pagestyle{sfheaders}

% Layout for chapter headers
\chapterstyle{southall}
\renewcommand*{\chaptitlefont}{\huge\sffamily\raggedright}

% Sectioning depth
% \setcounter{secnumdepth}{2} % doesn't work for some reason
\setsecnumdepth{subsection}
\settocdepth{subsection}

% Disemulate setspace
% \DisemulatePackage{setspace}
% \usepackage{setspace}
% \onehalfspacing

% Space requirements
\usepackage{needspace}

% Calculation stuff
\usepackage{calc}

% Creative Commons icons
\usepackage{ccicons}

% Use Python
% \usepackage[gobble=auto]{pythontex}

% Load fonts for XeTeX, including support for Unicode etc.
% Mathspec makes it possible to redefine *all* the fonts used for math stuff,
% however, it contains a stupid bug in dependency checking, see
% <http://tex.stackexchange.com/a/85700/60686>.
\usepackage{mathspec}
\makeatletter % undo the wrong changes made by mathspec
\let\RequirePackage\original@RequirePackage
\let\usepackage\RequirePackage
\makeatother
\usepackage{mathtools}
\usepackage{amsmath}

\usepackage{xunicode}
\usepackage{xltxtra}

% Handle language and quotation marks
\usepackage{polyglossia}
\setdefaultlanguage[variant=american]{english}
\usepackage[
	style=american,
	english=american,
	autopunct,
]{csquotes} % Put quotations in \enquote{} or \textquote{}!
\SetBlockEnvironment{quote}
\renewcommand*{\mkccitation}[1]{ (#1)}

% Fontawesome icons
\usepackage{fontawesome}

% Date and time
\usepackage[useregional]{datetime2}

% Extended formatting of lists
\usepackage{enumitem}
\newlist{glossdefs}{itemize}{1}
\setlist[glossdefs]{nosep, leftmargin=3em, labelwidth=2.5em, align=left}
\setlist[itemize]{noitemsep}

% Make multiple columns available in single-column document
\usepackage{multicol}

% Make text colors and color names available
\usepackage[xetex]{xcolor}

% Set main fonts
\usepackage[config=mt-Junicode]{microtype}

\setmainfont{Junicode}[
	Ligatures=TeX,
	Numbers=Lowercase,
]

\setsansfont{Fira Sans}[
	Ligatures=TeX,
	Numbers=Lowercase,
	Scale=MatchLowercase,
	BoldFont={* SemiBold},
]

\setmonofont{DejaVu Sans Mono}[
	Ligatures=TeX,
	Scale=MatchLowercase,
]

\setmathsfont(Digits,Latin,Greek)[
	Ligatures=TeX,
	Numbers=Lowercase,
]{Junicode}

\newfontfamily{\FS}[
	Ligatures=TeX,
	Script=Devanagari,
	Scale=MatchLowercase,
]{FreeSerif}

\newfontfamily{\Tagati}[
	Renderer=Graphite,
	Scale=0.9,
	BoldFont={* Italic},
	HyphenChar=·,
]{Tagati Book G}

% Relative font sizes
\usepackage{relsize}

% Set fonts for section headers
\setsecheadstyle{\sffamily\Large\raggedright}
\setsubsecheadstyle{\sffamily\bfseries\normalsize\raggedright}
\setsubsubsecheadstyle{\sffamily\itshape\normalsize\raggedright}

% Nicer footnotes
\usepackage[bottom,hang,norule]{footmisc}
\setlength{\footnotesep}{0.75\baselineskip}

% Load BibLaTeX (using Biber), configure citation styles
\usepackage[
	authordate-trad,
	backend=biber,
	safeinputenc,
	natbib,
]{biblatex-chicago}
\addbibresource{bibliography.bib}

% To make \textcite look like "Doe (2014: 213)"
\renewcommand*{\postnotedelim}{\addcolon\addspace}
\DeclareFieldFormat{postnote}{#1}
\DeclareFieldFormat{multipostnote}{#1}

% Print "~f." and "~ff." for \psq and \psqq, respectively
\DefineBibliographyStrings{english}{%
	sequens = {f.},
	sequentes = {ff.},
}

% Things for tables; needs to be loaded *before* hyperref if footnotes in tables 
% are supposed to work (bug in tabu where they still don't?)
\usepackage{longtable}
\usepackage{tabu}
\usepackage{booktabs}
\usepackage{bigstrut}
\usepackage{array}
% \AtBeginEnvironment{tabu}{\smaller}
% \usepackage{rotating}
% \usepackage{multirow}

% Dealing with page-size tables in landscape format
% http://tex.stackexchange.com/a/19021/60686, and hat tip to Git user Zoqaeski:
\usepackage{pdflscape} % alternative to rotating; rotates pages on screen
\usepackage{afterpage} % put things after the page they're defined on

% Appendices
\usepackage{appendix}

% Custom column types
\newcolumntype{B}{>{\bfseries}X}
\newcolumntype{I}{>{\itshape}X}
\newcolumntype{H}{>{\bfseries\footnotesize}X}
\newcolumntype{S}{>{\footnotesize}X}
\newcolumntype{C}{>{\scshape}X}

% Table header font
\newcommand{\tableheaderfont}{\rowfont{\upshape\bfseries\footnotesize}}
\newcommand{\tablesubheaderfont}{\rowfont{\upshape\bfseries\tiny}}

% Clickable links in footnotes, TOC, etc.
\usepackage[
	xetex,
	bookmarks=true,
	colorlinks=false,
	linktoc=section,
	hidelinks,
	pdfusetitle,
]{hyperref}

% Write "section" instead of "subsection", "subsubsection" etc.
\let\subsectionautorefname\sectionautorefname
\let\subsubsectionautorefname\sectionautorefname

% Formatting of URLs
% \DeclareFieldFormat{url}{\href{#1}{\itshape #1}}
% \def\UrlNoBreaks{\do\(\do\[\do\{\do\<\do\:}
\urlstyle{same}


% Ability to include graphics and dealing with footnotes in descriptions
\usepackage{graphicx}
\usepackage[font={small,sf},labelfont={small,sf},format=plain]{caption}
\usepackage{subcaption}
\usepackage{wrapfig}
\setlength{\columnsep}{2\baselineskip}
\usepackage{tikz}

% cf. http://tex.stackexchange.com/a/1912/60686
\tikzstyle{na} = [shape=rectangle,inner sep=0pt,text depth=0pt]
\tikzstyle{haspanno} = [font=\tiny,below=.75em, align=center, text width=2.5em, fill=white, text=black]
\tikzstyle{haspanno2} = [font=\tiny\sffamily\bfseries, align=left]

% Ability to draw tree diagrams
\usepackage[linguistics]{forest}
\usetikzlibrary{positioning}
\usetikzlibrary{tikzmark}

\forestset{shorter edges/.style={
	for tree={l sep-=.5em,l=0}
}}

\forestset{narrower nodes/.style={
	for tree={s sep-=.5em,s=0}
}}

% Definition copied from pgfsys-common-pdf-via-dvi.def
% Compare http://tex.stackexchange.com/q/229500 and comments!
% This is currently needed to make tikzmark compile with xelatex
\makeatletter
\def\pgfsys@hboxsynced#1{%
  {%
    \pgfsys@beginscope%
    \setbox\pgf@hbox=\hbox{%
      \hskip\pgf@pt@x%
      \raise\pgf@pt@y\hbox{%
        \pgf@pt@x=0pt%
        \pgf@pt@y=0pt%
        \special{pdf: content q}%
        \pgflowlevelsynccm% 
        \pgfsys@invoke{q -1 0 0 -1 0 0 cm}%
        \special{pdf: content -1 0 0 -1 0 0 cm q}% translate to original coordinate system
        \pgfsys@invoke{0 J [] 0 d}% reset line cap and dash
        \wd#1=0pt%
        \ht#1=0pt%
        \dp#1=0pt%
        \box#1%
        \pgfsys@invoke{n Q Q Q}%
      }%
      \hss%
    }%
    \wd\pgf@hbox=0pt%
    \ht\pgf@hbox=0pt%
    \dp\pgf@hbox=0pt%
    \pgfsys@hbox\pgf@hbox%
    \pgfsys@endscope%
  }%
}
\makeatother
% 
% % Ability to draw AVMs
% % (Requires avm.sty from http://nlp.stanford.edu/manning/tex/)
\usepackage{avm}
\avmfont{\scshape}
\avmvalfont{\normalfont}
% \AtBeginEnvironment{avm}{\smaller}

% Formatting of table of glossing abbreviations inspired by the example from 
% the leipzig package manual; here changed to use a user-defined list 
% environment, 'glossdefs' (see above).
\usepackage[acronym,nomain,nonumberlist,nopostdot]{glossaries}
\usepackage{glossary-inline}%

\newglossarystyle{mysuper}{%
	\glossarystyle{super}% based on super
	\renewenvironment{theglossary}{%
		\begin{glossdefs}%
	}{%
		\end{glossdefs}%
	}%
	\renewcommand*{\glossaryheader}{}%
	\renewcommand*{\glsgroupheading}[1]{}%
	\renewcommand*{\glossaryentryfield}[5]{%
		\item[\glsentryitem{##1}\glstarget{##1}{##2}]
		\makefirstuc{##3}\glspostdescription{}
	}%
	\renewcommand*{\glsgroupskip}{}%
}%

% Formatting of glosses
\usepackage{expex}
\pretocmd{\chapter}{\excnt=1}{}{}
\lingset{Everyex=\smaller}

% Third-level enumeration for expex examples,
% cf. http://tex.stackexchange.com/a/77941
\def\beginsubsub{%
\par
\begingroup
\advance\leftskip by 2em
\def\b##1{\par\leavevmode\llap{\hbox to 2em{##1\hfil}}\ignorespaces}}
\def\endsubsub{\par\endgroup}

% Glosses in footnotes
\newcounter{fnexno}
\setcounter{fnexno}{1}
\definelingstyle{fnex}{
	exno=\roman{fnexno}\stepcounter{fnexno},
	numoffset=\footnotemargin,
	exskip=0em,
	belowpreambleskip=-0.5em,
	interpartskip=-0.5em,
	aboveglftskip=-0.5em,
}

% Tahano Hikamu examples in the Writing System chapter
\definelingstyle{thex}{
	everygla=\upshape\Large,
	glwordalign=center,
	aboveglbskip=0.5em,
}

\usepackage{leipzig}

\newleipzig{AgtT}{at}{agent topic}
\newleipzig{PatT}{pt}{patient topic}
\newleipzig{DatT}{datt}{dative topic}
\newleipzig{GenT}{gent}{genitive topic}
\newleipzig{LocT}{loct}{locative topic}
\newleipzig{InsT}{inst}{instrumental topic}
\newleipzig{CauT}{caut}{causative topic}
\newleipzig{An}{an}{animate}
\newleipzig{Inan}{inan}{inanimate}
\newleipzig{Hab}{hab}{habitative}
\newleipzig{Ayr}{ayr}{Ayeri}
\newleipzig{NPst}{npst}{near past}
\newleipzig{RPst}{rpst}{remote past}
\newleipzig{NFut}{nfut}{near future}
\newleipzig{RFut}{rfut}{remote future}
\newleipzig{Agtz}{agtz}{agentizer}
\newleipzig{Dim}{dim}{diminutive}
\newleipzig{Comp}{comp}{comparative}
\newleipzig{Supl}{supl}{superlative}

\newleipzig{Dyn}{dyn}{dynamic}
\newleipzig{Hort}{hort}{hortative}
\newleipzig{Iter}{iter}{iterative}
\newleipzig{Aff}{aff}{affirmative}
\newleipzig{Int}{int}{intensifier}

\newleipzig{Adj}{adj}{adjective}
\newleipzig{Adp}{adp}{adposition}
\newleipzig{Lnk}{lnk}{linker}
\newleipzig{Nn}{nn}{noun}
\newleipzig{Post}{post}{postposition}
\newleipzig{Prep}{prep}{preposition}
\newleipzig{Sat}{sat}{satellite}
\newleipzig{Vb}{vb}{verb}

\newleipzig{AF}{af}{argument function}
\newleipzig{DF}{df}{discourse function}
\newleipzig{Adjc}{adj}{adjunct}
\newleipzig{Anim}{anim}{animacy}
\newleipzig{Case}{case}{case}
\newleipzig{Compar}{compar}{comparison}
\newleipzig{Compl}{comp}{complement}
\newleipzig{Gend}{gend}{gender}
\newleipzig{Index}{index}{index}
\newleipzig{Num}{num}{number}
\newleipzig{Obj}{obj}{object}
\newleipzig{SObj}{obj\fakesubscript{\normalfont\itshape θ}}{secondary object}
\newleipzig{Oblique}{obl}{oblique}
\newleipzig{Pers}{pers}{person}
\newleipzig{Pred}{pred}{predicator}
\newleipzig{Spec}{spec}{specificity}
\newleipzig{Sbj}{subj}{subject}
\newleipzig{Tense}{tense}{tense}
\newleipzig{XCompl}{xcomp}{open complement}

\makeglossaries

\newcommand{\AargI}{{\Aarg}.{\Inan}}
\newcommand{\PargI}{{\Parg}.{\Inan}}
\newcommand{\AgtTI}{{\AgtT}.{\Inan}}
\newcommand{\PatTI}{{\PatT}.{\Inan}}

\newcommand{\TsgM}{{\Tsg}.{\M}}
\newcommand{\TsgF}{{\Tsg}.{\F}}
\newcommand{\TsgN}{{\Tsg}.{\N}}
\newcommand{\TsgI}{{\Tsg}.{\Inan}}
\newcommand{\TplM}{{\Tpl}.{\M}}
\newcommand{\TplF}{{\Tpl}.{\F}}
\newcommand{\TplN}{{\Tpl}.{\N}}
\newcommand{\TplI}{{\Tpl}.{\Inan}}

\newcommand{\Oblq}[1]{\Oblique\fakesubscript{\normalfont\itshape #1}}
\newcommand{\OblqT}{\Oblique\fakesubscript{\normalfont\itshape θ}}

% Keyword index
\usepackage{makeidx}
\makeindex

% Smaller font in block quotes
\AtBeginEnvironment{quote}{\noindent\smaller}
\AtBeginEnvironment{quotation}{\smaller}

% Macros
\newcommand{\chk}{×} % Check mark
\newcommand{\err}{\faicon{bolt}} % FontAwesome icon `bolt'
\newcommand{\fw}[1]{\textit{#1}} % Foreign Word
\newcommand{\logand}{\textsc{and}} % logical "AND"
\newcommand{\logor}{\textsc{or}} % logical "OR"
\newcommand{\orth}[1]{⟨#1⟩}  % Orthography brackets
\newcommand{\pct}{\scalebox{.85}{ \%}} % Percent sign with half space before it
\newcommand{\ques}{\fakesuperscript{?}} % raised question mark
\newcommand{\rc}[1]{\rightcomment{[#1]}} % \rightcomment from expex in examples
\newcommand{\sic}{[{\itshape sic}]} % [sic]
\newcommand{\tc}[1]{\trailingcitation{#1}} % \trailingcitation from expex in examples
\newcommand{\thafterdot}{̒{\rmfamily }}%{\raisebox{.25em}{\zwsp F}{\rmfamily }}
\newcommand{\til}{$\sim$} %{\textasciitilde{}} % Tilde shortcut
\newcommand{\tit}[1]{\textit{#1}} % Title of a work
\newcommand{\tsub}[1]{\fakesubscript{#1}} % Subscript
\newcommand{\tsup}[1]{\fakesuperscript{#1}} % Superscript
\newcommand{\zero}{\textsc{ø}} % Small-caps Ø
\newcommand{\zwsp}{\mbox{​}} % Zero-width space (ZWSP)
\newcommand{\ten}{\textsc{a}} % Numeral A
\newcommand{\elv}{\textsc{b}} % Numeral B

\newcommand{\ayr}[1]{\zwsp\smash{{\Tagati #1}}} % Plain Ayeri orthography
\newcommand{\rayr}[2]{\zwsp\smash{{\Tagati #1}} \emph{#2}} % Ayeri orthography + *r*omanization
\newcommand{\tayr}[2]{\emph{#1} `#2'} % Romanization + *t*ranslation
\newcommand{\xayr}[3]{\zwsp\smash{\Tagati #1} \emph{#2} `#3'} % Ayeri orthography + romanization + translation

\usepackage{suffix}
\WithSuffix\newcommand{\ayr}*[1]{{\Tagati #1}} % Plain Ayeri orthography
\WithSuffix\newcommand{\rayr}*[2]{{\Tagati #1} \emph{#2}} % Ayeri orthography + *r*omanization
\WithSuffix\newcommand{\xayr}*[3]{{\Tagati #1} \emph{#2} `#3'} % Ayeri orthography + romanization + translation

% LFG annotation stuff
\newcommand{\Avm}{\textsc{avm}}
\newcommand{\Lfg}{\textsc{lfg}}
\newcommand{\downfeat}[2]{(↓~\textsc{#1})~=~\textsc{#2}} % (↓X) = Y
\newcommand{\downs}[1]{(↓~\textsc{#1})} % (↓X)
\newcommand{\elem}[1]{↓~$\in$~(↑~\textsc{#1})} % ↓ ∊ (↑X) 
\newcommand{\pass}[1]{(↑~\textsc{#1})~=~↓} % (↑X) = ↓
\newcommand{\req}{=\textit{\fakesubscript{c}}} % =_c
\newcommand{\uncertain}[1]{((x~↑)~\textsc{#1})~=~↑} % (x↑) X = ↑
\newcommand{\updown}{↑~=~↓} % ↑ = ↓
\newcommand{\upfeat}[2]{(↑~\textsc{#1})~=~\textsc{#2}} % (↑X) = Y
\newcommand{\ups}[1]{(↑~\textsc{#1})} % (↑X)
\newcommand{\xbar}[1]{#1ʹ} % X'
\newcommand{\xhead}[1]{#1⁰} % X⁰

% A-structure rules: \astruct[1]{2}{3} > '2 <3> 1'
\newcommand{\astruct}[3][]{`\emph{#2}~⟨#3⟩%
	\notblank{#1}{%
		~#1'}{%
		'}%
}

% Feature annotation above (for use in trees); no value in [] prints ↑ = ↓
\newcommand{\anno}[2][\updown{}]{%
	\begin{minipage}[c]{\widthof{\smaller\smaller #1}}\centering
		{\smaller\smaller #1}\\
		#2
	\end{minipage}%
}

% Feature annotation below (for use in phrase-structure rules); no value in [] prints ↑ = ↓
\WithSuffix\newcommand{\anno}*[2][\updown{}]{%
	\enspace%
	\begin{minipage}[c]{\widthof{\smaller\smaller #1}}\centering
		#2\\[-0.33\baselineskip]%
		{\smaller\smaller #1}%
	\end{minipage}\enspace%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

%% HALF TITLE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{titlingpage}
\begin{center}
{\Huge A Grammar of Ayeri}
\end{center}
\end{titlingpage}

%% TITLE PAGE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{titlingpage}
\titleS
\clearpage
\input{./chapters/colophon.tex}
\end{titlingpage}

%% FRONT MATTER %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\frontmatter
\begin{KeepFromToc}
  \tableofcontents
\end{KeepFromToc}
\clearpage
\listoffigures
\clearpage
\listoftables
\chapter{Abbreviations}
\begin{multicols}{2}
\printglossary[style=mysuper,type=\leipzigtype]
\end{multicols}
\cleartorecto

\input{./chapters/preface.tex}
\cleartorecto

%% MAIN MATTER %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\mainmatter

\input{./chapters/introduction.tex}
\cleartorecto

\input{./chapters/phonology.tex}
\cleartorecto

\input{./chapters/writing.tex}
\cleartorecto

\input{./chapters/morphtyp.tex}
\cleartorecto

\input{./chapters/gramcat.tex}
\cleartorecto

\input{./chapters/syntax.tex}
\cleartorecto

%% APPENDIX %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\appendix
\cleartorecto

\input{./chapters/names.tex}
\cleartorecto

%% BIBLIOGRAPHY %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\printbibliography

%% BACK MATTER %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\backmatter
\printindex

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\end{document}
